<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Binance Futures Margin & Cost Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --accent: #ffffff;
            --muted: #444444;
            --dim: #1a1a1a;
            --border-color: #333;
            --highlight: #f0b90b;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            margin: 0;
            padding: 2rem;
            background: var(--bg);
            color: var(--accent);
            min-height: 100vh;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 200;
            font-size: 2rem;
            color: var(--accent);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .tool-box {
            background: var(--surface);
            border: 1px solid var(--dim);
            padding: 2rem;
            height: fit-content;
        }

        .tool-header {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--dim);
            color: var(--highlight);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        label {
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.4rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
        }

        .row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .col {
            flex: 1;
            min-width: 140px;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--dim);
            background: var(--bg);
            color: var(--accent);
            font-family: 'Inter', monospace;
            font-size: 0.9rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        select:focus {
            border-color: var(--muted);
            outline: none;
        }

        .radio-group {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .radio-group label {
            cursor: pointer;
            color: var(--accent);
            text-transform: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.7;
            font-size: 0.8rem;
        }

        .radio-group label:hover {
            opacity: 1;
        }

        .radio-group input {
            margin: 0;
        }

        button {
            padding: 1rem;
            font-size: 0.9rem;
            background-color: var(--accent);
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--bg);
            text-transform: uppercase;
            transition: opacity 0.3s;
            width: 100%;
            margin-top: 1.5rem;
        }

        button.secondary {
            background-color: var(--dim);
            color: var(--accent);
            border: 1px solid var(--muted);
            margin-top: 1rem;
            padding: 0.8rem;
            font-size: 0.8rem;
        }

        button:hover {
            opacity: 0.8;
        }

        .order-list {
            margin-top: 1rem;
            border: 1px solid var(--dim);
            padding: 0.5rem;
            background: var(--bg);
        }

        .order-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: end;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--dim);
        }

        .order-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .remove-btn {
            background: transparent;
            color: #ff4444;
            width: auto;
            padding: 0 0.5rem;
            margin: 0;
            font-size: 1.2rem;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .result-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--bg);
            border: 1px solid var(--dim);
            white-space: pre-wrap;
            font-family: 'Inter', monospace;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .hidden {
            display: none;
        }

        .note {
            font-size: 0.65rem;
            color: var(--muted);
            margin-top: 0.2rem;
        }
    </style>
</head>

<body>
    <h1>Margin & Cost Calculator</h1>

    <div class="container">
        <!-- TOOL 1: MARGIN REQUIREMENT -->
        <div class="tool-box" id="marginTool">
            <div class="tool-header">Margin Requirement</div>
            <form id="marginForm">
                <!-- Config -->
                <div class="row">
                    <div class="col">
                        <label>Contract Type</label>
                        <div class="radio-group" name="marginContractType">
                            <label><input type="radio" name="m_type" value="usdm" checked> USDⓈ-M</label>
                            <label><input type="radio" name="m_type" value="coinm"> Coin-M</label>
                        </div>
                    </div>
                    <div class="col">
                        <label>Position Mode</label>
                        <div class="radio-group" name="marginPosMode">
                            <label><input type="radio" name="m_mode" value="oneway" checked> One-Way</label>
                            <label><input type="radio" name="m_mode" value="hedge"> Hedge</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Mark Price</label>
                        <input type="number" id="m_markPrice" step="any" required>
                    </div>
                    <div class="col">
                        <label>Leverage (x)</label>
                        <input type="number" id="m_leverage" value="10" required>
                    </div>
                </div>

                <div id="m_coinmFields" class="hidden row">
                    <div class="col">
                        <label>Contract Value (USD)</label>
                        <input type="number" id="m_contractVal" placeholder="e.g. 100">
                    </div>
                </div>

                <!-- One-Way Existing Position -->
                <div id="m_onewayPos">
                    <div class="section-title">Existing Position (One-Way)</div>
                    <div class="row">
                        <div class="col">
                            <label>Size <span class="m_unit">(Coin)</span></label>
                            <input type="number" id="m_ow_size" value="0">
                        </div>
                        <div class="col">
                            <label>Side</label>
                            <select id="m_ow_side">
                                <option value="LONG">Long</option>
                                <option value="SHORT">Short</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Hedge Existing Position -->
                <div id="m_hedgePos" class="hidden">
                    <div class="section-title">Existing Positions (Hedge)</div>
                    <div class="row">
                        <div class="col">
                            <label>Long Pos Size</label>
                            <input type="number" id="m_h_longSize" value="0">
                        </div>
                        <div class="col">
                            <label>Short Pos Size</label>
                            <input type="number" id="m_h_shortSize" value="0">
                        </div>
                    </div>
                </div>

                <!-- Open Orders -->
                <div class="section-title">Open Orders</div>
                <div id="m_orders" class="order-list"></div>
                <button type="button" class="secondary" id="m_addOrderBtn">+ Add Open Order</button>

                <button type="button" id="m_calcBtn">Calculate Margin Req</button>

                <div id="m_result" class="result-box hidden"></div>
            </form>
        </div>

        <!-- TOOL 2: COST CALCULATOR -->
        <div class="tool-box" id="costTool">
            <div class="tool-header">Cost Calculator</div>
            <p style="font-size:0.8rem; color:var(--muted); margin-bottom:1rem;">
                Calculates Initial Margin + Open Loss for a <strong>New Open Order</strong>.
            </p>
            <form id="costForm">
                <div class="row">
                    <div class="col">
                        <label>Contract Type</label>
                        <div class="radio-group">
                            <label><input type="radio" name="c_type" value="usdm" checked> USDⓈ-M</label>
                            <label><input type="radio" name="c_type" value="coinm"> Coin-M</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Mark Price</label>
                        <input type="number" id="c_markPrice" step="any" required>
                    </div>
                    <div class="col">
                        <label>Leverage (x)</label>
                        <input type="number" id="c_leverage" value="10" required>
                    </div>
                </div>

                <div id="c_coinmFields" class="hidden row">
                    <div class="col">
                        <label>Contract Value (USD)</label>
                        <input type="number" id="c_contractVal" placeholder="e.g. 100">
                    </div>
                </div>

                <div class="section-title">New Order Details</div>
                <div class="row">
                    <div class="col">
                        <label>Order Size <span class="c_unit">(Coin)</span></label>
                        <input type="number" id="c_size" step="any" required>
                    </div>
                    <div class="col">
                        <label>Limit Price</label>
                        <input type="number" id="c_price" step="any" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Side</label>
                        <select id="c_side">
                            <option value="BUY">Buy / Long</option>
                            <option value="SELL">Sell / Short</option>
                        </select>
                    </div>
                </div>

                <button type="button" id="c_calcBtn">Calculate Cost</button>
                <div id="c_result" class="result-box hidden"></div>
            </form>
        </div>
    </div>

    <footer style="text-align:center; margin-top:3rem; font-size:0.7rem; color:var(--muted);">
        <a href="index.html" style="color:var(--muted); text-decoration:none;">&larr; Back to Tools</a>
    </footer>

    <script>
        /* ================= MARGIN TOOL LOGIC ================= */
        const mTypeRadios = document.getElementsByName('m_type');
        const mModeRadios = document.getElementsByName('m_mode');
        const mCoinmFields = document.getElementById('m_coinmFields');
        const mOneWayPosDiv = document.getElementById('m_onewayPos');
        const mHedgePosDiv = document.getElementById('m_hedgePos');
        const mOrdersDiv = document.getElementById('m_orders');
        const mResult = document.getElementById('m_result');
        const mUnits = document.querySelectorAll('.m_unit');

        let mOrderCounter = 0;

        function updateM_UI() {
            const type = Array.from(mTypeRadios).find(r => r.checked).value;
            const mode = Array.from(mModeRadios).find(r => r.checked).value;

            if (type === 'coinm') {
                mCoinmFields.classList.remove('hidden');
                mUnits.forEach(u => u.textContent = "(Cont)");
            } else {
                mCoinmFields.classList.add('hidden');
                mUnits.forEach(u => u.textContent = "(Coin)");
            }

            if (mode === 'hedge') {
                mOneWayPosDiv.classList.add('hidden');
                mHedgePosDiv.classList.remove('hidden');
            } else {
                mOneWayPosDiv.classList.remove('hidden');
                mHedgePosDiv.classList.add('hidden');
            }

            // Re-render orders because One-way vs Hedge have different order types
            renderAllOrders();
        }

        mTypeRadios.forEach(r => r.addEventListener('change', updateM_UI));
        mModeRadios.forEach(r => r.addEventListener('change', updateM_UI));

        function renderAllOrders() {
            // Keep existing values if possible? 
            // For simplicity, we just clear for now when switching mode, to avoid invalid state.
            // But let's try to preserve. 
            // Actually, One-Way orders are just Buy/Sell. Hedge orders are Open/Close Long/Short.
            // We'll wipe for simplicity to prevent confusion.
            mOrdersDiv.innerHTML = '';
            addM_Order();
        }

        function addM_Order() {
            const id = mOrderCounter++;
            const mode = Array.from(mModeRadios).find(r => r.checked).value;

            const div = document.createElement('div');
            div.className = 'order-item';
            div.id = `m_order_${id}`;

            let typeOptions = '';
            if (mode === 'oneway') {
                typeOptions = `
                    <option value="BUY">Buy</option>
                    <option value="SELL">Sell</option>
                 `;
            } else {
                typeOptions = `
                    <option value="OPEN_LONG">Open Long</option>
                    <option value="CLOSE_LONG">Close Long</option>
                    <option value="OPEN_SHORT">Open Short</option>
                    <option value="CLOSE_SHORT">Close Short</option>
                 `;
            }

            div.innerHTML = `
                <div class="col">
                    <label>Size</label>
                    <input type="number" class="o-size" placeholder="0">
                </div>
                <div class="col">
                    <label>Limit Price</label>
                    <input type="number" class="o-price" placeholder="0">
                </div>
                <div class="col">
                    <label>Type</label>
                    <select class="o-type">
                        ${typeOptions}
                    </select>
                </div>
                <button type="button" class="remove-btn" onclick="removeM_Order(${id})">&times;</button>
            `;
            mOrdersDiv.appendChild(div);
        }

        window.removeM_Order = (id) => {
            const el = document.getElementById(`m_order_${id}`);
            if (el) el.remove();
        };

        document.getElementById('m_addOrderBtn').addEventListener('click', addM_Order);

        document.getElementById('m_calcBtn').addEventListener('click', () => {
            const type = Array.from(mTypeRadios).find(r => r.checked).value;
            const mode = Array.from(mModeRadios).find(r => r.checked).value;
            const markPrice = parseFloat(document.getElementById('m_markPrice').value);
            const leverage = parseFloat(document.getElementById('m_leverage').value);
            const contractVal = (type === 'coinm') ? parseFloat(document.getElementById('m_contractVal').value) : 1;

            if (!markPrice || !leverage) {
                alert("Please enter Mark Price and Leverage.");
                return;
            }
            if (type === 'coinm' && !contractVal) {
                alert("Please enter Contract Value for Coin-M.");
                return;
            }

            // Helpers
            // USD-M Notional = Size * Price.
            // Coin-M Notional (in Contract Terms for formula?)
            // Formula from Binance: "In Coin-Margined: Notional Value = Position Size  * Contract Value / Mark Price" (This gives Value in Coin)
            // Order Value: "Order Size * Contract Value / Limit Price" (This gives Value in Coin)

            const getPosNotional = (size) => {
                if (type === 'usdm') return size * markPrice;
                return (size * contractVal) / markPrice;
            };

            const getOrderValue = (size, price) => {
                if (type === 'usdm') return size * price;
                return (size * contractVal) / price;
            };

            // 1. Gather Orders
            let longBidVal = 0; // Buy / Open Long
            let longAskVal = 0; // Sell / Close Long
            let shortBidVal = 0; // Close Short (Buy)
            let shortAskVal = 0; // Open Short (Sell)

            // Standardizing for One-Way:
            // "Bid Order Value" = Buy Orders
            // "Ask Order Value" = Sell Orders

            const orderRows = mOrdersDiv.querySelectorAll('.order-item');
            orderRows.forEach(row => {
                const s = parseFloat(row.querySelector('.o-size').value) || 0;
                const p = parseFloat(row.querySelector('.o-price').value) || 0;
                const t = row.querySelector('.o-type').value;

                if (s > 0 && p > 0) {
                    const val = getOrderValue(s, p);

                    if (mode === 'oneway') {
                        if (t === 'BUY') longBidVal += val;
                        else longAskVal += val; // Sell = Ask
                    } else {
                        // Hedge Map
                        // Open Long -> Increases Long Pos -> Treated as Long Bid for margin check?
                        // Formula: "Long-Side Margin = Max(Abs(LongPos + LongBid), Abs(LongPos - LongAsk))"
                        // Long Bid = Orders increasing Long pos (Open Long)
                        // Long Ask = Orders decreasing Long pos (Close Long)
                        if (t === 'OPEN_LONG') longBidVal += val;
                        if (t === 'CLOSE_LONG') longAskVal += val;

                        // Short Side
                        // "Short-Side Margin = Max(Abs(ShortPos + ShortBid), Abs(ShortPos - ShortAsk))"
                        // Note: Short Pos is negative?
                        // "For short positions, the position size is negative"
                        // Logic:
                        // Short Bid = Orders closing Short (Buying back) -> Reducting Short Size (Positive impact on negative size?)
                        // Short Ask = Orders increasing Short (Selling more) -> Making it more negative
                        if (t === 'CLOSE_SHORT') shortBidVal += val;
                        if (t === 'OPEN_SHORT') shortAskVal += val;
                    }
                }
            });

            // 2. Calculate Logic
            let resultText = "";

            if (mode === 'oneway') {
                const size = parseFloat(document.getElementById('m_ow_size').value) || 0;
                const side = document.getElementById('m_ow_side').value;
                let rawPosNotional = getPosNotional(size);
                if (side === 'SHORT') rawPosNotional = -rawPosNotional;

                // Formula: Max(Abs(Pos + Bid), Abs(Pos - Ask)) / Lev
                // Note: Bid/Ask here are unsigned values (Values are magnitudes).
                // Wait, "Bid Order Value" itself is positive? Formula: "Position Notional + Bid Order Value"
                // If Pos is -100 (Short), and Bid is +50 (Buy). Sum = -50. Abs = 50. Correct.
                // If Pos is -100, Ask is 50 (Sell). "Pos - Ask" -> -100 - 50 = -150. Abs = 150. Correct.

                const term1 = Math.abs(rawPosNotional + longBidVal);
                const term2 = Math.abs(rawPosNotional - longAskVal);
                const req = Math.max(term1, term2) / leverage;

                resultText = `Margin Requirement: ${req.toFixed(5)} ${type === 'usdm' ? 'USDT' : 'Coin'}`;
            }
            else {
                // Hedge
                const lSize = parseFloat(document.getElementById('m_h_longSize').value) || 0;
                const sSize = parseFloat(document.getElementById('m_h_shortSize').value) || 0;

                const lNotional = getPosNotional(lSize); // Positive
                const sNotional = -getPosNotional(sSize); // Negative

                // Long Side Req
                const l_term1 = Math.abs(lNotional + longBidVal);
                const l_term2 = Math.abs(lNotional - longAskVal);
                const longReq = Math.max(l_term1, l_term2) / leverage;

                // Short Side Req
                const s_term1 = Math.abs(sNotional + shortBidVal); // ShortBid = Close Short
                const s_term2 = Math.abs(sNotional - shortAskVal); // ShortAsk = Open Short
                const shortReq = Math.max(s_term1, s_term2) / leverage;

                const total = longReq + shortReq;

                resultText = `Total Margin Requirement: ${total.toFixed(5)}\n\n(Long Side: ${longReq.toFixed(5)} + Short Side: ${shortReq.toFixed(5)})`;
            }

            mResult.innerText = resultText;
            mResult.classList.remove('hidden');
        });

        updateM_UI(); // init margin UI

        /* ================= COST TOOL LOGIC ================= */
        const cTypeRadios = document.getElementsByName('c_type');
        const cCoinmFields = document.getElementById('c_coinmFields');
        const cUnits = document.querySelectorAll('.c_unit');
        const cResult = document.getElementById('c_result');

        function updateC_UI() {
            const type = Array.from(cTypeRadios).find(r => r.checked).value;
            if (type === 'coinm') {
                cCoinmFields.classList.remove('hidden');
                cUnits.forEach(u => u.textContent = "(Cont)");
            } else {
                cCoinmFields.classList.add('hidden');
                cUnits.forEach(u => u.textContent = "(Coin)");
            }
        }
        cTypeRadios.forEach(r => r.addEventListener('change', updateC_UI));

        document.getElementById('c_calcBtn').addEventListener('click', () => {
            const type = Array.from(cTypeRadios).find(r => r.checked).value;
            const markPrice = parseFloat(document.getElementById('c_markPrice').value);
            const leverage = parseFloat(document.getElementById('c_leverage').value);
            const size = parseFloat(document.getElementById('c_size').value);
            const price = parseFloat(document.getElementById('c_price').value);
            const side = document.getElementById('c_side').value;
            const contractVal = (type === 'coinm') ? parseFloat(document.getElementById('c_contractVal').value) : 1;

            if (!markPrice || !leverage || !size || !price) {
                alert("Please fill all fields.");
                return;
            }
            if (type === 'coinm' && !contractVal) {
                alert("Please enter Contract Value.");
                return;
            }

            // Cost = Initial Margin + Open Loss
            // IM = Order Value / Leverage

            let orderVal = 0;
            if (type === 'usdm') orderVal = size * price;
            else orderVal = (size * contractVal) / price;

            const initMargin = orderVal / leverage;

            // Open Loss
            // If Buy: Loss if Price > Mark?
            // No, if I buy at 20000, and Mark is 19000 -> I am immediately losing.
            // Entry Price would be Limit Price (assuming filled).
            // Loss = (Entry - Mark) * Size (for Long)?
            // Long PNL = (Mark - Entry) * Size.
            // If PNL is negative -> Loss.
            // Loss = Max(0, -PNL).

            // USD-M PNL
            // Long: (Mark - Entry) * Size
            // Short: (Entry - Mark) * Size

            let pnl = 0;
            if (type === 'usdm') {
                if (side === 'BUY') pnl = (markPrice - price) * size;
                else pnl = (price - markPrice) * size;
            } else {
                // Coin-M PNL
                // Long: Size * ContractVal * (1/Entry - 1/Mark)
                // Short: Size * ContractVal * (1/Mark - 1/Entry)
                if (side === 'BUY') pnl = size * contractVal * (1 / price - 1 / markPrice);
                else pnl = size * contractVal * (1 / markPrice - 1 / price);
            }

            const openLoss = (pnl < 0) ? Math.abs(pnl) : 0;
            const totalCost = initMargin + openLoss;

            const cur = (type === 'usdm') ? 'USDT' : 'Coin';

            cResult.innerText = `
                Cost Required: ${totalCost.toFixed(5)} ${cur}
                ------------------
                Initial Margin: ${initMargin.toFixed(5)}
                Open Loss: ${openLoss.toFixed(5)}
             `;
            cResult.classList.remove('hidden');
        });

        updateC_UI();
    </script>
</body>

</html>