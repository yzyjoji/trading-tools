<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trade Tools - UTC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --accent: #ffffff;
            --muted: #444444;
            --dim: #1a1a1a;
            --border-color: #333;
            --highlight: #fcd535;
            /* Keep Binance yellow as subtle highlight */
            --success-color: #0ecb81;
            --danger-color: #f6465d;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--accent);
            margin: 0;
            padding: 2rem;
            height: 100vh;
            overflow: hidden;
        }

        /* Content & Layout */
        .tab-content {
            display: block;
            max-width: 800px;
            margin: 0 auto;
            background-color: transparent;
            padding: 0;
            box-shadow: none;
        }

        h2 {
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        p {
            font-weight: 300;
            color: var(--muted);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
        }

        input,
        select {
            width: 100%;
            padding: 1rem;
            background-color: var(--surface);
            border: 1px solid var(--dim);
            color: var(--accent);
            border-radius: 0;
            box-sizing: border-box;
            font-family: 'Inter', monospace;
            /* Monospace for numbers/dates if needed, layout mostly Inter */
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        input:focus,
        select:focus {
            border-color: var(--muted);
            outline: none;
        }

        /* Buttons */
        button.action-btn {
            background-color: var(--accent);
            color: var(--bg);
            border: none;
            padding: 1rem 2rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 0;
            margin-top: 1rem;
            width: 100%;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: opacity 0.3s ease;
        }

        button.action-btn:hover {
            opacity: 0.8;
        }

        .copy-btn {
            background-color: transparent;
            color: var(--muted);
            border: 1px solid var(--dim);
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            border-radius: 0;
            font-size: 0.7rem;
            float: right;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Results Area */
        #results-area {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--dim);
            display: none;
        }

        .status-indicator {
            padding: 1rem;
            border-radius: 0;
            margin-bottom: 1.5rem;
            border: 1px solid var(--dim);
            background: var(--surface);
            font-size: 0.9rem;
            font-weight: 300;
        }

        .status-missed {
            border-left: 3px solid var(--success-color);
            color: var(--accent);
        }

        .status-hit {
            border-left: 3px solid var(--danger-color);
            color: var(--accent);
        }

        .macro-container {
            background-color: var(--surface);
            border: 1px solid var(--dim);
            border-radius: 0;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .macro-text {
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 300;
        }

        .table-container {
            max-height: 300px;
            overflow-y: auto;
            background: var(--surface);
            border: 1px solid var(--dim);
        }

        /* Custom Scrollbar */
        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--surface);
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--dim);
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

        .price-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .price-table th,
        .price-table td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--dim);
        }

        .price-table th {
            position: sticky;
            top: 0;
            background-color: var(--dim);
            color: var(--muted);
            font-weight: 400;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
        }

        .price-table td {
            color: var(--accent);
            font-weight: 300;
        }

        .low-val {
            color: var(--danger-color);
        }

        .high-val {
            color: var(--success-color);
        }
    </style>
</head>

<body>


    <!-- Kline Checker Tab -->
    <div id="KlineChecker" class="tab-content">
        <h2>Binance Futures Order Validator (UTC)</h2>
        <p style="color:#888; font-size: 0.9em;">
            <strong>IMPORTANT:</strong> This tool forces <strong>UTC Time</strong>.
            Ensure timestamps are UTC (e.g., 2025-12-05 15:00:00).
        </p>

        <div class="form-group">
            <label for="symbol">Symbol</label>
            <input type="text" id="symbol" placeholder="BTCUSDT" value="BTCUSDT">
        </div>

        <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;">
                <label for="orderSide">Order Side</label>
                <select id="orderSide">
                    <option value="buy">BUY</option>
                    <option value="sell">SELL</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="limitPrice">Limit Order Price (USDT)</label>
                <input type="number" id="limitPrice" placeholder="e.g. 95000.50" step="any">
            </div>
        </div>

        <div class="form-group">
            <label for="startTime">Trigger Time (UTC)</label>
            <input type="text" id="startTime" placeholder="YYYY-MM-DD HH:mm:ss">
        </div>

        <div class="form-group">
            <label for="endTime">End Time (UTC)</label>
            <input type="text" id="endTime" placeholder="YYYY-MM-DD HH:mm:ss">
        </div>

        <button class="action-btn" onclick="checkKlines()">Check Price History</button>

        <div id="results-area">

            <div id="logic-status" class="status-indicator"></div>

            <h3>Analysis Response</h3>
            <div class="macro-container">
                <button class="copy-btn" onclick="copyMacro()">Copy Response</button>
                <div style="clear:both;"></div>
                <div id="macro-output" class="macro-text"></div>
            </div>

            <h3 style="margin-top:20px;">
                Price Data (1m Candles - UTC)
                <button class="copy-btn" onclick="copyTable()">Copy Table Data</button>
            </h3>
            <div class="table-container">
                <table class="price-table" id="data-table">
                    <thead>
                        <tr>
                            <th>Time (UTC)</th>
                            <th>Open</th>
                            <th>High</th>
                            <th>Low</th>
                            <th>Close</th>
                        </tr>
                    </thead>
                    <tbody id="price-list-body">
                        <!-- Data rows go here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Tab Functionality ---
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // --- STRICT UTC PARSING ---
        function parseUTCInput(dateString) {
            if (!dateString) return null;

            // Clean string
            const cleanStr = dateString.trim().replace(' ', 'T');

            // We manually parse YMDHMS to ensure no browser locale interference
            // Assumes format YYYY-MM-DD HH:mm:ss
            const regex = /^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/;
            const match = dateString.match(regex);

            if (match) {
                // Date.UTC(year, monthIndex, day, hour, minute, second)
                return Date.UTC(
                    parseInt(match[1]),
                    parseInt(match[2]) - 1,
                    parseInt(match[3]),
                    parseInt(match[4]),
                    parseInt(match[5]),
                    parseInt(match[6])
                );
            }

            // Fallback: Append 'Z' to force UTC if ISO format is close
            const dateObj = new Date(cleanStr + 'Z');
            if (!isNaN(dateObj.getTime())) return dateObj.getTime();

            return null;
        }

        // --- Format UTC for Display ---
        function formatUTCTime(timestamp) {
            const d = new Date(timestamp);
            // format: YYYY-MM-DD HH:mm:ss
            return d.toISOString().replace('T', ' ').substring(0, 19);
        }

        // --- Main Logic ---
        async function checkKlines() {
            const symbol = document.getElementById('symbol').value.toUpperCase();
            const orderSide = document.getElementById('orderSide').value;
            const limitPriceVal = document.getElementById('limitPrice').value;
            const startInput = document.getElementById('startTime').value.trim();
            const endInput = document.getElementById('endTime').value.trim();

            const resultsArea = document.getElementById('results-area');
            const listBody = document.getElementById('price-list-body');
            const macroOutput = document.getElementById('macro-output');
            const logicStatus = document.getElementById('logic-status');

            // Validation
            if (!symbol || !startInput || !endInput || !limitPriceVal) {
                alert("Please fill in all fields.");
                return;
            }

            // Use strict UTC Parser
            const startTime = parseUTCInput(startInput);
            const endTime = parseUTCInput(endInput);
            const limitPrice = parseFloat(limitPriceVal);

            if (!startTime || !endTime) {
                alert("Invalid date format. Please use YYYY-MM-DD HH:mm:ss");
                return;
            }
            if (startTime >= endTime) {
                alert("Start time must be before End time.");
                return;
            }

            // Fetch Data (Binance Futures Last Price)
            const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1m&startTime=${startTime}&endTime=${endTime}&limit=1000`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Binance API Error`);
                const data = await response.json();

                if (data.length === 0) {
                    alert("No data found. Check your dates.");
                    return;
                }

                // Process Data
                let globalHigh = -Infinity;
                let globalLow = Infinity;
                let rowsHTML = "";

                data.forEach(kline => {
                    // Binance returns start time in ms
                    const timestamp = kline[0];
                    const kTimeUTC = formatUTCTime(timestamp);

                    const kOpen = parseFloat(kline[1]);
                    const kHigh = parseFloat(kline[2]);
                    const kLow = parseFloat(kline[3]);
                    const kClose = parseFloat(kline[4]);

                    if (kHigh > globalHigh) globalHigh = kHigh;
                    if (kLow < globalLow) globalLow = kLow;

                    rowsHTML += `
                        <tr>
                            <td>${kTimeUTC}</td>
                            <td>${kOpen}</td>
                            <td>${kHigh}</td>
                            <td class="low-val">${kLow}</td>
                            <td>${kClose}</td>
                        </tr>
                    `;
                });

                // --- LOGIC CHECK ---
                let shouldHaveExecuted = false;
                let logicMessage = "";

                if (orderSide === 'buy') {
                    // BUY LIMIT: Market Low must be <= Limit
                    if (globalLow <= limitPrice) {
                        shouldHaveExecuted = true;
                        logicMessage = `Reason: The Lowest Price in chart (${globalLow}) was lower than or equal to your Buy Limit (${limitPrice}).`;
                    }
                } else {
                    // SELL LIMIT: Market High must be >= Limit
                    if (globalHigh >= limitPrice) {
                        shouldHaveExecuted = true;
                        logicMessage = `Reason: The Highest Price in chart (${globalHigh}) was higher than or equal to your Sell Limit (${limitPrice}).`;
                    }
                }

                resultsArea.style.display = "block";
                listBody.innerHTML = rowsHTML;

                if (!shouldHaveExecuted) {
                    // SUCCESS: Price was missed
                    logicStatus.className = "status-indicator status-missed";
                    logicStatus.innerHTML = `<strong>✓ Logic Verified:</strong> Price on chart never reached your Limit Price.`;

                    macroOutput.innerText = `Thank you very much for waiting.

After your stop limit order was triggered the limit order became active for this duration :
from : ${startInput} (UTC)
to : ${endInput} (UTC)

During this specific time, the market was highly volatile.
• Lowest Price in chart: ${globalLow}
• Highest Price in chart: ${globalHigh}

Your Limit Price was set at ${limitPrice} USDT.

Although your Stop Price triggered the order, the market price quickly jumped past your Limit Price. Because a Limit Order guarantees a specific price or better, and the market price was worse than your limit at that moment, the order could not be filled immediately.

This is normal behavior for Stop Limit orders during fast market movements.`;

                } else {
                    // WARNING: Price was hit
                    logicStatus.className = "status-indicator status-hit";
                    logicStatus.innerHTML = `<strong>⚠ ALERT:</strong> The Limit Price WAS crossed in this timeframe (UTC).<br>${logicMessage}`;

                    macroOutput.innerText = `⚠ CAUTION: DO NOT USE THE STANDARD MACRO.

Analysis for ${orderSide.toUpperCase()} Order (UTC Time):
• Limit Price: ${limitPrice}
• Lowest Chart Price: ${globalLow}
• Highest Chart Price: ${globalHigh}

Conclusion:
The price on the chart indicates the order SHOULD have been executable. 
${logicMessage}

Possible reasons for failure despite price match:
1. Order Queue Priority (Others were ahead of you).
2. "Fill or Kill" or "Post Only" restrictions.
3. The price wick was too fast for the matching engine to catch your specific volume.

Please escalate or investigate further.`;
                }

            } catch (error) {
                console.error(error);
                alert("Error fetching data.");
            }
        }

        // --- FIXED COPY FUNCTIONS (Compatible with local files) ---
        function copyMacro() {
            const text = document.getElementById('macro-output').innerText;

            // Use textarea hack for maximum compatibility
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            alert("Response copied!");
        }

        function copyTable() {
            const table = document.getElementById("data-table");
            let rowData = [];
            let headers = [];

            // Get Headers
            for (let th of table.rows[0].cells) headers.push(th.innerText);
            rowData.push(headers.join("\t"));

            // Get Data
            for (let i = 1; i < table.rows.length; i++) {
                let rowCells = [];
                for (let cell of table.rows[i].cells) rowCells.push(cell.innerText);
                rowData.push(rowCells.join("\t"));
            }

            const finalText = rowData.join("\n");

            // Use textarea hack for maximum compatibility
            const el = document.createElement('textarea');
            el.value = finalText;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            alert("Table copied for Excel!");
        }
    </script>
</body>

</html>

<script>

</script>
</body>

</html>