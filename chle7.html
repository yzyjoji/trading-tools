<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chle7 Mode | Premium Tracker</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <!-- Tesseract.js & Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Palette: Modern Deep Space FinTech */
            --bg-dark: #050505;
            --bg-gradient: radial-gradient(circle at 15% 50%, rgba(32, 29, 72, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 85% 30%, rgba(20, 50, 40, 0.4) 0%, transparent 50%);

            --card-glass: rgba(20, 20, 20, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-hover: rgba(30, 30, 30, 0.8);

            --primary: #00E599;
            /* Electric Emerald */
            --primary-dim: rgba(0, 229, 153, 0.1);
            --primary-glow: 0 0 20px rgba(0, 229, 153, 0.3);

            --danger: #FF4757;
            --warning: #FFA502;

            --text-main: #FFFFFF;
            --text-muted: #8899A6;

            --font-display: 'Outfit', sans-serif;
            --font-body: 'Inter', sans-serif;

            --radius-lg: 24px;
            --radius-md: 12px;
            --anim-speed: 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            background-color: var(--bg-dark);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            font-family: var(--font-body);
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }

        /* --- UTILS --- */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- LAYOUT --- */
        .app-wrapper {
            width: 100%;
            max-width: 1300px;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 2rem;
            position: relative;
        }

        /* --- HEADER --- */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 1rem;
        }

        .brand {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #8899A6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .user-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* --- CARDS --- */
        .card {
            background: var(--card-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            margin-bottom: 2rem;
            transition: var(--anim-speed);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03) 0%, transparent 100%);
            pointer-events: none;
        }

        h2 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- FORMS --- */
        .input-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input,
        select {
            width: 100%;
            padding: 0.9rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
            font-family: var(--font-body);
            transition: var(--anim-speed);
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 229, 153, 0.1);
            background: rgba(0, 0, 0, 0.4);
        }

        .row {
            display: flex;
            gap: 1rem;
        }

        .col {
            flex: 1;
        }

        button.primary-btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 1rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-family: var(--font-display);
            cursor: pointer;
            width: 100%;
            letter-spacing: 0.5px;
            transition: var(--anim-speed);
        }

        button.primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--primary-glow);
            background: #2bffb3;
        }

        /* --- OCR UPLOAD --- */
        .ocr-zone {
            border: 2px dashed var(--card-border);
            border-radius: var(--radius-md);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--anim-speed);
        }

        .ocr-zone:hover {
            border-color: var(--primary);
            background: var(--primary-dim);
        }

        .ocr-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        /* --- STATS & RESULTS --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.25rem;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid transparent;
            transition: var(--anim-speed);
        }

        .stat-box:hover {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-display);
            margin-top: 0.25rem;
        }

        .val-pos {
            color: var(--primary);
            text-shadow: 0 0 10px rgba(0, 229, 153, 0.3);
        }

        .val-neg {
            color: var(--danger);
            text-shadow: 0 0 10px rgba(255, 71, 87, 0.3);
        }

        /* --- HEALTH BAR --- */
        .health-wrapper {
            background: rgba(0, 0, 0, 0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
            position: relative;
        }

        .health-fill {
            height: 100%;
            transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            border-radius: 4px;
            box-shadow: 0 0 10px currentColor;
        }

        .health-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: var(--text-muted);
        }

        /* --- LIST --- */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .txn-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 1rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
            transition: 0.2s;
        }

        .txn-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .txn-item.expense {
            border-left-color: var(--danger);
        }

        .txn-main {
            font-weight: 600;
            font-family: var(--font-display);
            font-size: 1rem;
        }

        .txn-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .txn-amount {
            font-family: var(--font-display);
            font-weight: 700;
            color: var(--text-main);
        }

        /* --- AUTH OVERLAY --- */
        #login-overlay {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            background: #0f0f0f;
            border: 1px solid var(--card-border);
            padding: 3rem;
            border-radius: 32px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .auth-box::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 229, 153, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        @media (max-width: 900px) {
            .app-wrapper {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- AUTH OVERLAY -->
    <div id="login-overlay">
        <div class="auth-box fade-in" id="card-login">
            <h1 style="font-family: var(--font-display); font-size: 2rem; margin-bottom: 0.5rem;">Welcome Back</h1>
            <p style="color: var(--text-muted); margin-bottom: 2.5rem;">Access your secure financial vault</p>

            <div class="input-group"><input type="text" id="login-username" placeholder="Username"></div>
            <div class="input-group"><input type="password" id="login-password" placeholder="PIN Code"></div>

            <label
                style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 1.5rem 0; cursor: pointer;">
                <input type="checkbox" id="remember-me" style="width: auto; margin: 0;"> Keep me logged in
            </label>

            <button class="primary-btn" onclick="performLogin()">UNLOCK VAULT</button>
            <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted); cursor: pointer;"
                onclick="toggleAuthMode()">New user? <span style="color: var(--primary);">Create Account</span></p>
            <p id="login-error" style="color: var(--danger); margin-top: 1rem; display: none;">Invalid credentials</p>
        </div>

        <div class="auth-box hidden fade-in" id="card-signup">
            <h1 style="font-family: var(--font-display); font-size: 2rem; margin-bottom: 0.5rem;">Join Now</h1>
            <p style="color: var(--text-muted); margin-bottom: 2.5rem;">Start your journey to financial freedom</p>

            <div class="input-group"><input type="text" id="reg-username" placeholder="Choose Username"></div>
            <div class="input-group"><input type="password" id="reg-password" placeholder="Set a PIN"></div>

            <button class="primary-btn" onclick="performRegister()">CREATE ACCOUNT</button>
            <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted); cursor: pointer;"
                onclick="toggleAuthMode()">Already have an account? <span style="color: var(--primary);">Login</span>
            </p>
            <p id="reg-error" style="color: var(--danger); margin-top: 1rem; display: none;">Username taken</p>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div class="app-wrapper" id="app-container">

        <div class="header">
            <div class="brand">Chle7 Mode<span style="color: var(--primary);">.</span></div>
            <div class="user-controls">
                <span id="user-welcome" style="color: var(--text-main); font-weight: 500;">User</span>
                <select id="month-selector" onchange="renderApp()"
                    style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: rgba(255,255,255,0.05);">
                    <!-- JS Fills -->
                </select>
                <button onclick="exportData()"
                    style="background: none; border: 1px solid rgba(0, 229, 153, 0.4); color: var(--primary); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; margin-right: 0.5rem;">Backup
                    Data</button>
                <button onclick="logout()"
                    style="background: none; border: 1px solid rgba(255,255,255,0.2); color: var(--text-muted); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">Log
                    Out</button>
            </div>
        </div>

        <!-- LEFT COLUMN: CONTROLS -->
        <div class="control-panel">

            <!-- PROFILE -->
            <div class="card fade-in" style="animation-delay: 0.1s;">
                <h2>Wallet Settings</h2>
                <div class="row input-group">
                    <div class="col">
                        <label>Income</label>
                        <input type="number" id="salary-input" placeholder="0.00" onchange="saveUserData()">
                    </div>
                    <div class="col">
                        <label>Target Limit (%)</label>
                        <input type="number" id="limit-input" placeholder="70" value="70" onchange="saveUserData()">
                    </div>
                </div>
                <!-- Savings removed from main view to reduce clutter, can just auto-calc or keep simple -->
                <div class="input-group">
                    <label>Current Total Savings Base</label>
                    <input type="number" id="savings-input" placeholder="0.00" onchange="saveUserData()">
                </div>
            </div>

            <!-- ACTION -->
            <div class="card fade-in" style="animation-delay: 0.2s;">
                <h2>New Transaction</h2>

                <div class="input-group">
                    <label>Category</label>
                    <select id="trans-category" onchange="handleCategoryChange()">
                        <option value="Rent">Rent & Housing</option>
                        <option value="Food">Food & Dining</option>
                        <option value="Transportation">Transport</option>
                        <option value="Subscriptions">Subscriptions</option>
                        <option value="Bills">Utilities & Bills</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Others">Others</option>
                    </select>
                </div>

                <div id="sub-category-wrapper" class="input-group hidden">
                    <label>Specifics</label>
                    <select id="trans-subcategory">
                        <option value="Groceries">Groceries</option>
                        <option value="Restaurant">Restaurant</option>
                        <option value="Takeout">Takeout</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Drinks">Drinks</option>
                    </select>
                </div>

                <div id="custom-desc-wrapper" class="input-group hidden">
                    <label>Details</label>
                    <input type="text" id="trans-desc" placeholder="What was this?">
                </div>

                <div class="input-group">
                    <label>Amount</label>
                    <input type="number" id="trans-amount" placeholder="0.00"
                        style="font-size: 1.2rem; font-weight: 600; color: var(--primary);">
                </div>

                <button class="primary-btn" onclick="addTransaction()">ADD EXPENSE</button>
            </div>

            <!-- SCANNER -->
            <div class="card fade-in" style="animation-delay: 0.3s; padding: 1.5rem;">
                <h2>Smart Scan</h2>
                <div class="ocr-zone" onclick="document.getElementById('ocr-upload').click()">
                    <div class="ocr-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--primary);">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <p style="font-weight: 500;">Upload Bank Statement</p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">Auto-detects expenses
                        and "Virement" transfers</p>
                    <input type="file" id="ocr-upload" accept="image/*" style="display: none;"
                        onchange="processOCR(this)">
                </div>
                <div id="ocr-status"
                    style="font-size: 0.8rem; margin-top: 1rem; text-align: center; color: var(--primary);"></div>
            </div>

        </div>

        <!-- RIGHT COLUMN: ANALYTICS -->
        <div class="analytics-panel">

            <div class="card fade-in" style="animation-delay: 0.2s;">
                <h2>Monthly Overview</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total Spent</div>
                        <div class="stat-val val-neg" id="val-expenses">$0.00</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Remaining</div>
                        <div class="stat-val" id="val-remaining">$0.00</div>
                    </div>
                </div>

                <div
                    style="background: linear-gradient(135deg, rgba(0,229,153,0.1) 0%, rgba(0,0,0,0) 100%); padding: 1.5rem; border-radius: var(--radius-md); border: 1px solid var(--primary-dim);">
                    <div class="stat-label" style="color: var(--primary);">Projected Total Savings</div>
                    <div class="stat-val val-pos" id="val-savings" style="font-size: 2rem;">$0.00</div>
                </div>

                <!-- HEALTH BAR -->
                <div style="margin-top: 2rem;">
                    <div class="health-meta">
                        <span id="health-text">Spending Status</span>
                        <span id="limit-display">Target: $0.00</span>
                    </div>
                    <div class="health-wrapper">
                        <div class="health-fill" id="health-bar" style="width: 0%; background: var(--primary);"></div>
                    </div>
                </div>

                <!-- CHART -->
                <div style="margin-top: 2rem; height: 250px;">
                    <canvas id="liquidityChart"></canvas>
                </div>
            </div>

            <!-- HISTORY -->
            <div class="card fade-in" style="animation-delay: 0.4s; flex: 1;">
                <h2>
                    History
                    <button onclick="clearHistory()"
                        style="background: none; border: none; color: var(--text-muted); font-size: 0.8rem; cursor: pointer; text-decoration: underline;">Clear
                        All</button>
                </h2>
                <div class="input-group" style="margin-bottom: 0.5rem;">
                    <input type="text" id="search-input" placeholder="Search transactions..." onkeyup="renderApp()"
                        style="padding: 0.6rem 1rem; font-size: 0.9rem;">
                </div>
                <div class="history-list" id="history-list">
                    <!-- JS fills -->
                </div>
            </div>

        </div>

    </div>

    <!-- LOGIC SCRIPTS -->
    <script>
        // --- CONSTANTS ---
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- APP STATE ---
        let STORAGE_KEY = 'spending_tracker_db_v1';
        let REMEMBER_KEY = 'spending_tracker_active_user';
        let db = {};
        let currentUser = null;
        let chartInstance = null;

        // --- INIT ---
        window.onload = function () {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) db = JSON.parse(savedData);
            initMonthSelector();
            const rememberedUser = localStorage.getItem(REMEMBER_KEY);
            if (rememberedUser && db[rememberedUser]) loginUser(rememberedUser);
        }

        // --- AUTH SYSTEM ---
        function toggleAuthMode() {
            document.getElementById('card-login').classList.toggle('hidden');
            document.getElementById('card-signup').classList.toggle('hidden');
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('reg-error').style.display = 'none';
        }
        function performRegister() {
            const user = document.getElementById('reg-username').value.trim();
            const pass = document.getElementById('reg-password').value.trim();
            if (!user || !pass) return alert("Please fill all fields");
            if (db[user]) {
                document.getElementById('reg-error').innerText = "Username already exists.";
                document.getElementById('reg-error').style.display = 'block';
                return;
            }
            db[user] = { pin: pass, salary: 0, savings: 0, limitPct: 70, transactions: [] };
            saveDB();
            alert("Welcome! Please login.");
            toggleAuthMode();
            document.getElementById('login-username').value = user;
        }
        function performLogin() {
            const user = document.getElementById('login-username').value.trim();
            const pass = document.getElementById('login-password').value.trim();
            if (db[user] && db[user].pin === pass) {
                if (document.getElementById('remember-me').checked) localStorage.setItem(REMEMBER_KEY, user);
                loginUser(user);
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }
        function loginUser(username) {
            currentUser = username;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('user-welcome').innerText = username;
            document.getElementById('salary-input').value = db[currentUser].salary || '';
            document.getElementById('savings-input').value = db[currentUser].savings || '';
            document.getElementById('limit-input').value = db[currentUser].limitPct || 70;
            renderApp();
        }
        function logout() {
            localStorage.removeItem(REMEMBER_KEY);
            location.reload();
        }
        function saveDB() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
        function saveUserData() {
            if (!currentUser) return;
            db[currentUser].salary = parseFloat(document.getElementById('salary-input').value) || 0;
            db[currentUser].savings = parseFloat(document.getElementById('savings-input').value) || 0;
            db[currentUser].limitPct = parseFloat(document.getElementById('limit-input').value) || 70;
            saveDB();
            renderApp();
        }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "finance_backup_" + new Date().toISOString().slice(0, 10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // --- APP LOGIC ---
        function initMonthSelector() {
            const selector = document.getElementById('month-selector');
            const currentMonthIndex = new Date().getMonth();
            MONTHS.forEach((m, index) => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                if (index === currentMonthIndex) opt.selected = true;
                selector.appendChild(opt);
            });
        }
        function handleCategoryChange() {
            const cat = document.getElementById('trans-category').value;
            const subWrapper = document.getElementById('sub-category-wrapper');
            const descWrapper = document.getElementById('custom-desc-wrapper');
            subWrapper.classList.add('hidden');
            descWrapper.classList.add('hidden');
            if (cat === 'Food') subWrapper.classList.remove('hidden');
            else if (cat === 'Others') descWrapper.classList.remove('hidden');
        }
        function addTransaction(overrideCategory = null, overrideDesc = null, overrideAmount = null, forceMonth = null) {
            if (!currentUser) return;
            const selectedMonth = forceMonth || document.getElementById('month-selector').value;
            let category = overrideCategory || document.getElementById('trans-category').value;
            let amount = overrideAmount || parseFloat(document.getElementById('trans-amount').value);
            let description = overrideDesc || category;
            if (!amount || amount <= 0) return alert("Please enter a valid amount.");
            if (!overrideCategory) {
                if (category === 'Food') description = document.getElementById('trans-subcategory').value;
                else if (category === 'Others') description = document.getElementById('trans-desc').value.trim() || description;
            }
            db[currentUser].transactions.unshift({
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                month: selectedMonth,
                category: category,
                description: description,
                amount: amount
            });
            saveDB();
            document.getElementById('trans-amount').value = '';
            document.getElementById('trans-desc').value = '';
            renderApp();
        }

        // --- HISTORY EDITING ---
        function deleteTransaction(id) {
            if (!confirm("Delete this transaction?")) return;
            db[currentUser].transactions = db[currentUser].transactions.filter(t => t.id !== id);
            saveDB();
            renderApp();
        }

        function editTransaction(id) {
            const tx = db[currentUser].transactions.find(t => t.id === id);
            if (!tx) return;

            const newDesc = prompt("Edit Description:", tx.description);
            if (newDesc !== null) {
                tx.description = newDesc;
                saveDB();
                renderApp();
            }
        }

        function renderApp() {
            if (!currentUser) return;
            const selectedMonth = document.getElementById('month-selector').value;
            const listContainer = document.getElementById('history-list');
            const transactions = db[currentUser].transactions || [];

            // Search Filtering
            const searchInput = document.getElementById('search-input');
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';

            const filtered = transactions.filter(t => {
                const matchesMonth = t.month === selectedMonth;
                const matchesSearch = t.description.toLowerCase().includes(searchQuery) || t.category.toLowerCase().includes(searchQuery);
                return matchesMonth && matchesSearch;
            });

            // Calculate Totals (on filtered or montly? Standard is monthly totals, filtered view)
            // But if user searches "Rent", they might want to see total Rent.
            // Let's stick to Month totals for the top cards to remain useful as a budgeting tool, 
            // and just filter the list view.

            const monthTransactions = transactions.filter(t => t.month === selectedMonth);
            let totalSpent = 0;
            monthTransactions.forEach(t => totalSpent += parseFloat(t.amount));

            listContainer.innerHTML = '';
            if (filtered.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem; font-style: italic;">No transactions found.</div>';
            } else {
                filtered.forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'txn-item expense';
                    el.innerHTML = `
                        <div class="txn-info" style="flex: 1;">
                            <div class="txn-main">${t.category}</div>
                            <div class="txn-sub">${t.description} • ${t.date}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="txn-amount">-$${parseFloat(t.amount).toFixed(2)}</div>
                            <div style="font-size: 0.7rem; margin-top: 4px; opacity: 0.6;">
                                <span style="cursor: pointer; margin-right: 8px; color: var(--primary);" onclick="editTransaction(${t.id})">EDIT</span>
                                <span style="cursor: pointer; color: var(--danger);" onclick="deleteTransaction(${t.id})">DEL</span>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(el);
                });
            }
            const salary = db[currentUser].salary;
            const savings = db[currentUser].savings;
            const limitPct = db[currentUser].limitPct || 70;
            const remaining = salary - totalSpent;

            document.getElementById('val-expenses').innerText = formatCurrency(totalSpent);
            const remEl = document.getElementById('val-remaining');
            remEl.innerText = formatCurrency(remaining);
            remEl.className = remaining >= 0 ? 'stat-val val-pos' : 'stat-val val-neg';
            document.getElementById('val-savings').innerText = formatCurrency(savings + remaining);

            // Health Bar
            updateHealthBar(totalSpent, salary, limitPct);

            // Chart
            renderChart(transactions, salary);
        }

        function updateHealthBar(totalSpent, salary, limitPct) {
            const bar = document.getElementById('health-bar');
            const label = document.getElementById('health-text');
            const limitDisplay = document.getElementById('limit-display');

            const targetAmount = salary * (limitPct / 100);
            limitDisplay.innerText = `Limit: ${formatCurrency(targetAmount)} (${limitPct}%)`;

            if (salary <= 0) { bar.style.width = '0%'; return; }

            let pct = (totalSpent / targetAmount) * 100;
            if (pct > 100) pct = 100;

            bar.style.width = pct + '%';

            // Color Swapping
            if (pct < 50) {
                bar.style.backgroundColor = '#00E599'; // Green
                bar.style.boxShadow = '0 0 10px rgba(0,229,153,0.5)';
                label.innerText = "Safe Zone";
                label.style.color = '#00E599';
            } else if (pct < 85) {
                bar.style.backgroundColor = '#FFA502'; // Orange
                bar.style.boxShadow = '0 0 10px rgba(255,165,2,0.5)';
                label.innerText = "Be Careful";
                label.style.color = '#FFA502';
            } else {
                bar.style.backgroundColor = '#FF4757'; // Red
                bar.style.boxShadow = '0 0 10px rgba(255,71,87,0.5)';
                label.innerText = "Critical Limit";
                label.style.color = '#FF4757';
            }
        }

        function renderChart(transactions, salary) {
            const ctx = document.getElementById('liquidityChart').getContext('2d');
            let currentLiquidity = db[currentUser].savings;
            const labels = [];
            const dataPoints = [];
            let liquid = currentLiquidity;

            const monthlyExpenses = {};
            MONTHS.forEach(m => monthlyExpenses[m] = 0);
            transactions.forEach(t => {
                if (monthlyExpenses[t.month] !== undefined) monthlyExpenses[t.month] += t.amount;
            });

            MONTHS.forEach(m => {
                const expenses = monthlyExpenses[m];
                const net = salary - expenses;
                liquid += net;
                labels.push(m.substring(0, 3));
                dataPoints.push(liquid);
            });

            if (chartInstance) chartInstance.destroy();

            // Chart Styling for Dark Theme
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Liquidity',
                        data: dataPoints,
                        borderColor: '#00E599',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(0, 229, 153, 0.4)');
                            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                            return gradient;
                        },
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#050505',
                        pointBorderColor: '#00E599',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#8899A6', font: { family: 'Inter' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#8899A6', font: { family: 'Inter' } }
                        }
                    }
                }
            });
        }

        function clearHistory() {
            if (confirm("Clear all transactions? This cannot be undone.")) {
                db[currentUser].transactions = [];
                saveDB();
                renderApp();
            }
        }
        function formatCurrency(val) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val); }

        function processOCR(input) {
            const statusDiv = document.getElementById('ocr-status');
            if (input.files && input.files[0]) {
                const img = input.files[0];
                statusDiv.innerText = "Analyzing Receipt...";

                Tesseract.recognize(img, 'eng').then(({ data: { text } }) => {
                    const lines = text.split('\n');
                    let count = 0;

                    // Regex for currency: $50.00, 50.00, etc.
                    const moneyRegex = /-\s?\$?\s?(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/;

                    lines.forEach(line => {
                        const match = moneyRegex.exec(line);
                        if (match) {
                            let amountStr = match[1].replace(/,/g, '');
                            const amount = parseFloat(amountStr);

                            if (isNaN(amount) || amount === 0) return;

                            const lowerLine = line.toLowerCase();

                            // 1. Check for Transfer
                            if (lowerLine.includes('virement') || lowerLine.includes('transfer')) {
                                if (confirm(`Found Transfer: $${amount.toFixed(2)}.\n"${line.trim()}"\n\nCount as an Expense?`)) {
                                    addTransaction('Others', 'Virement Transfer', amount);
                                    count++;
                                }
                                return;
                            }

                            // 2. Extract Description (Parsing Name)
                            let desc = line.replace(match[0], ''); // remove money match

                            // Remove date-like patterns (e.g., 12/05, 2024-01-01)
                            desc = desc.replace(/\b\d{1,4}[/-]\d{1,2}[/-]?\d{0,4}\b/g, '');

                            // Remove common currency symbols and OCR noise
                            desc = desc.replace(/[$€£|©®]/g, '');

                            // Trim and clean
                            desc = desc.replace(/\s+/g, ' ').trim();

                            if (desc.replace(/[^a-zA-Z]/g, '').length < 3) desc = 'Imported Item'; // Fallback

                            addTransaction('Others', desc, amount);
                            count++;
                        }
                    });

                    statusDiv.innerText = `Done! Imported ${count} items.`;
                    renderApp();
                }).catch(err => {
                    console.error(err);
                    statusDiv.innerText = "Scan Failed.";
                });
            }
        }
    </script>
</body>

</html>